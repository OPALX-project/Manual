ifdef::env-gitlab[]
:stem: latexmath
:sectnums:
:toc: macro
:toclevels: 3

link:home[Back to Main Page]

toc::[]
endif::[]

[[chp.opalmap]]
== _OPAL-map_

**_OPAL-map_ is work in progress.**


[[sec.opalmap.introduction]]
=== Introduction

OPAL-map is an map tracking beam optics code. This type computes maps for each beam line element to describe the action of the system.  


The map creation is done by applying the Lie Operator on the element Hamiltonian and calculated in the Truncated Power Series Algebra (TPSA)<<bib.berz1999_opalmap>>. The TPSA is a Differential Algebra (DA), which uses the Taylor expansion as the equivalent function. In OPAL-map the TPSA gets provided from the own OPAL DA-package. 


In contrast to time latexmath:[t] dependent tracking codes, as OPAL-t, map tracking codes use the longitudinal bunch position latexmath:[s] as independent variable. Furthermore, map tracking codes do not use numerical integrators for the determination of the particle trajectory, which can be a computationally very expensive.

The main advantage in map tracking codes lies in the ''map'' itself. These do not only contain valuable information about the beam line, but also can be accumulated to reduce the computational effort in the particle tracking.

[[sec.opalmap.variablesopalmap]]
=== Variables in _OPAL-map
For in and outputs, the units as in `link:opalt#sec.opalt.variablesopalt[Variables in OPAL-t]` are used.

_OPAL-map_ uses an Frenet-Serret coordinate system, referring on a reference particle. This particle has the ideal properties, ergo follows the design path. The following canonical variables to describe the motion of particles. The physical units are listed in square brackets.

X::
  Horizontal position latexmath:[x] of a particle relative to the reference particle [m].
PX::
  latexmath:[\frac{p_x}{P_0}] Normalized horizontal canonical momentum [1].
(Where latexmath:[p_x] is the momentum of the particle and latexmath:[P_0] is the momentum of the reference particle)

Y::
  Horizontal position latexmath:[y] of a particle relative to the reference particle [m].
PY::
  latexmath:[\frac{p_y}{P_0}] Normalized horizontal canonical momentum [1].
Z::
  Longitudinal position latexmath:[z] of a particle relatice to the reference particle [m].
DELTA::
  latexmath:[\frac{E}{P_0 c}-\frac{1}{\beta_0}] Energy derviation [1]. 
(Where latexmath:[E] is the total energy of the particle and latexmath:[\beta_0 = \frac{u}{c}] the speed relative to the speed of light latexmath:[c] of the reference particle)

The independent variable is position of the reference particle *s* [m].


[[sec.opalmap.mapTracking]]
=== Principle of Map Tracking

The particle motion gets calculated by applying the map on the particle parameter. <<fig_MapTracking>>
[#fig_MapTracking]
.Flow chart of map tracking.
image::figures/opalmap/mapTracking.png[scaledwidth=8cm]

[latexmath]
++++
v^f = \mathbf{\mathcal{M}} \circ v^i
++++
Where latexmath:[v] denotes the final (latexmath:[v^f]) and initial (latexmath:[v^i]) six dimensional phase space vector of each particle.
latexmath:[\mathbf{\mathcal{M}}] is the map. This map can represent either a beam element slice, the whole element, a beam line section or the whole system.

[[sec.opalmap.creationOfMap]]
=== Creation of map

The creation of the element map is based on the Hamiltonian Mechanic, more specificly on the Lie Operator.

[latexmath]
++++
\begin{aligned}
    H &= T + V\\
    \frac{d\vec{q_i}}{ds} &= \frac{\partial H}{\partial p_i} \; , \;  \frac{d\vec{p_i}}{ds} = - \frac{\partial H}{\partial q_i}
\end{aligned}
++++
\frac{d\vec{q_i}}{ds} &= \frac{\partial H}{\partial p_i} \; , \;  \frac{d\vec{p_i}}{ds} = - \frac{\partial H}{\partial q_i}
Here latexmath:[H], the time dependent Hamiltonian represents the total energy, consisting of the kinetic latexmath:[T] and potential latexmath:[V] energy.
The lower equations are the Hamiltonian equations of motion, where the momenta latexmath:[p_i] and the positons latexmath:[q_i] form the cannonical paris.
Using cannonical transformations, the Hamiltonian can be adjusted to use the pathlength latexmath:[s] as independent and the particle parameters as depenedent variable(s).


Introducing the Lie operator, which acts similar to a "waiting" Poissant Bracket:
[latexmath]
++++
\begin{aligned}
    :\!f\!:  = \left[ f, \circ \right] = \sum_{i=1}^{n} \left( \frac{\partial f}{\partial q_i}\frac{\partial \circ}{\partial p_i} - \frac{\partial f}{\partial p_i}\frac{\partial \circ}{\partial q_i} \right)
\end{aligned}
++++

If a function latexmath:[f:= f_{\left( \vec{q_{(s)}},\vec{p_{(s)}}\right) }] describes one of the phase space variables latexmath:[v] its total derivative to the independent variable, combined with the Hamiltonian equations of motions, is similar to the Lie operator times the independ variable, i. e. latexmath:[s].

[latexmath]
++++
\begin{aligned}
    \frac{df}{ds}&= \sum_{i=1}^{n} \left( \frac{dq_i}{ds}\frac{\partial f}{\partial q_i} +\frac{dp_i}{ds}\frac{\partial f}{\partial p_i} \right) \\
    \frac{df}{ds}&= \sum_{i=1}^{n} \left( \frac{\partial H}{\partial p_i}\frac{\partial f}{\partial q_i} -\frac{\partial H}{\partial q_i}\frac{\partial f}{\partial p_i} \right)  \equiv -:\!H\!: f
\end{aligned}
++++

The integral over the independent variable:

[latexmath]
++++
\begin{aligned}
    f_{(s)}&= e^{-\lieoperator{H} s} f_{(s_0)}\\
	\mathcal{M} &= e^{-:\!H\!: s}
\end{aligned}
++++

Where latexmath:[e^{-:\!H\!: s}] is the Lie expansion. 


[[sec.opalmap.example]]
=== Example

FODO lattice: https://gitlab.psi.ch/OPAL/Manual-2.0/wikis/examples/FODOmap.in[FODO.in]

To `RUN` OPAL-map, the `METHOD` attribute gets set to `THICK`. 
....
RUN, METHOD = "THICK", BEAM=BEAM1, FIELDSOLVER=FS1, DISTRIBUTION=DIST1;
....

The maximal order of the beam line maps get defined with the `MAP_ORDER` attribute.
....
TRACK, LINE= QUADTEST, BEAM=BEAM1, MAXSTEPS=10000, DT=1.0e-10, ZSTOP=4.0, MAP_ORDER=2;
....

As an optional parameter for the beam line elements `NSlices=<x>` provides the opportunity to split one element in `<x>` smaller steps. Otherwise, the default value is defined with `1`.

....
D1:  DRIFT, 		L=1., 		     ELEMEDGE=0.000, NSLICES=10;
QP1: QUADRUPOLE, 	L=0.3, 	K1= 8.64195, ELEMEDGE=1.000, NSLICES=15;
....


[[sec.opalmap.output]]
=== Output


[bibliography]
=== References
* [[[bib.berz1999_opalmap]]] Martin Berz. Modern map methods in particle beam physics. eng. ISBN: 978-0-12-014750-2. San Diego: Academic Press, 1999.
